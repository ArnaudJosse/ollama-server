<!doctype html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat local IA</title>
    <style>
    /* √† personnaliser selon vos envies */
    body { font-family: system-ui; background: #222; color: #fff; padding: 2rem; }
    #chat, [type=submit] { padding: 1rem; border-radius: 0.5rem; border: 1px solid #ccc; margin: 1rem 0; background: inherit; color: inherit; }
    #chat { min-width: 60rem; font-size: inherit; }
    #reponse { text-align: left; line-height: 2; }
    #modelSelector { line-height: 2; font-size: 16px!important; padding: 1rem; }
    #modelLabel { font-size: 18px!important; padding: 1rem; }
    </style>
</head>
<body>
<h1>Chat Local ü•ù</h1>

<form>
    <label for="modelSelector" id="modelLabel">S√©lectionnez un mod√®le de langage :</label>
    <select id="modelSelector">

    </select>
    <br>
    <input type="text" id="chat" placeholder="Votre prompt ...">
    <button type="submit">Envoyer</button>
</form>
<div id="reponse"></div>

<script type="module">
    const form = document.querySelector('form');
    const input = document.querySelector('#chat');
    const selector = document.querySelector('#modelSelector');
    const resultat = document.querySelector('#reponse');

    //r√©cup√©ration des mod√®les
    const response= await fetch ("http://192.168.1.14:11434/api/tags",{
        method: "GET",
        dataType: "jsonp",
        
    })
    const listOfModels=await response.json()
    //console.log(typeof(models.models))
    //console.log(models.models)
    const models=listOfModels.models
    const selectElement=document.getElementById ("modelSelector")
    for (const model of models)
    {

        //console.log (model.name)
        const option=document.createElement('option')
        option.value=model.name
        option.textContent=model.name
        selectElement.appendChild (option)
    }


    // √Ä la validation du formulaire
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // On r√©cup√®re le contenu du message
        const content = input.value.trim();
        //on r√©cup√®re le nom du mod√®le
        const model = selector.value.trim();
        console.log (model)
        if (!content) return; // Si c'est vide on arr√™te l√†

        // Petit message d'attente
        resultat.textContent = 'Un instant et je suis √† vous...';
        // On vide le champ d'entr√©e
        input.value = '';

        try {
            // Requ√™te asynchrone en POST vers /chat
            const response = await fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                // Corps de la requ√™te en JSON
                body: JSON.stringify({ 'model': model,'content': content }),
            });

            resultat.textContent = '';

            // On instancie une interface ReadableStream
            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            // Tant qu'on a du contenu...
            while (true) {
                const { done, value } = await reader.read(); // On lit
                if (done) break;

                const lines = decoder.decode(value).split('\n');

                // On it√®re sur la r√©ponse re√ßue pour alimenter le r√©sultat
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.slice(6));
                        resultat.textContent += data.content;
                    }
                }
            }
        } catch (error) {
            console.error('Error:', error);
            resultat.textContent = 'Une erreur est survenue.';
        }
    });
</script>

</body>
</html>
